#!/bin/bash

# Open Deep Research AKS éƒ¨ç½²è„šæœ¬
set -e

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                                                                           â•‘"
echo "â•‘              Open Deep Research - AKS è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬                      â•‘"
echo "â•‘                                                                           â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# é…ç½®å˜é‡
DOCKER_IMAGE="shankswhite/open-deep-research"
VERSION="v1.0"
NAMESPACE="deep-research"
OPENAI_API_KEY="${OPENAI_API_KEY:-}"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“‹ é…ç½®ä¿¡æ¯"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "Docker é•œåƒ:  $DOCKER_IMAGE:$VERSION"
echo "Namespace:    $NAMESPACE"
echo "OpenAI Key:   ${OPENAI_API_KEY:0:20}..." # åªæ˜¾ç¤ºå‰20ä¸ªå­—ç¬¦
echo ""

# æ£€æŸ¥ OpenAI API Key
if [ -z "$OPENAI_API_KEY" ]; then
    echo -e "${RED}âŒ é”™è¯¯: æœªè®¾ç½® OPENAI_API_KEY ç¯å¢ƒå˜é‡${NC}"
    echo ""
    echo "è¯·ä½¿ç”¨ä»¥ä¸‹æ–¹å¼ä¹‹ä¸€è®¾ç½®:"
    echo "  1. export OPENAI_API_KEY='your-api-key-here'"
    echo "  2. OPENAI_API_KEY='your-api-key-here' ./deploy.sh"
    echo ""
    exit 1
fi

# æ­¥éª¤ 1: åˆ›å»º Namespace
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“¦ æ­¥éª¤ 1/6: åˆ›å»º Namespace"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
kubectl apply -f namespace.yaml
echo -e "${GREEN}âœ… Namespace å·²åˆ›å»º/æ›´æ–°${NC}"
echo ""

# æ­¥éª¤ 2: åˆ›å»º Secret
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ” æ­¥éª¤ 2/6: åˆ›å»º OpenAI API Key Secret"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# æ£€æŸ¥ Secret æ˜¯å¦å·²å­˜åœ¨
if kubectl get secret openai-api-key -n $NAMESPACE >/dev/null 2>&1; then
    echo -e "${YELLOW}âš ï¸  Secret 'openai-api-key' å·²å­˜åœ¨ï¼Œåˆ é™¤æ—§ Secret...${NC}"
    kubectl delete secret openai-api-key -n $NAMESPACE
fi

# åˆ›å»ºæ–° Secret
kubectl create secret generic openai-api-key \
    --from-literal=OPENAI_API_KEY="$OPENAI_API_KEY" \
    -n $NAMESPACE

echo -e "${GREEN}âœ… Secret å·²åˆ›å»º${NC}"
echo ""

# æ­¥éª¤ 3: åˆ›å»º ConfigMap
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âš™ï¸  æ­¥éª¤ 3/6: åˆ›å»º ConfigMap"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
kubectl apply -f configmap.yaml
echo -e "${GREEN}âœ… ConfigMap å·²åˆ›å»º/æ›´æ–°${NC}"
echo ""

# æ­¥éª¤ 4: éƒ¨ç½²åº”ç”¨
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸš€ æ­¥éª¤ 4/6: éƒ¨ç½²åº”ç”¨"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
kubectl apply -f deployment.yaml
echo -e "${GREEN}âœ… Deployment å·²åˆ›å»º/æ›´æ–°${NC}"
echo ""

# æ­¥éª¤ 5: åˆ›å»º Service
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸŒ æ­¥éª¤ 5/6: åˆ›å»º Service"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
kubectl apply -f service.yaml
echo -e "${GREEN}âœ… Service å·²åˆ›å»º/æ›´æ–°${NC}"
echo ""

# æ­¥éª¤ 6: ç­‰å¾… Pod å°±ç»ª
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "â³ æ­¥éª¤ 6/6: ç­‰å¾… Pod å°±ç»ª"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ç­‰å¾… Pod å¯åŠ¨ï¼ˆæœ€å¤šç­‰å¾… 5 åˆ†é’Ÿï¼‰..."
kubectl wait --for=condition=ready pod \
    -l app=open-deep-research \
    -n $NAMESPACE \
    --timeout=300s || {
        echo -e "${RED}âŒ Pod å¯åŠ¨è¶…æ—¶${NC}"
        echo ""
        echo "æŸ¥çœ‹ Pod çŠ¶æ€:"
        kubectl get pods -n $NAMESPACE -l app=open-deep-research
        echo ""
        echo "æŸ¥çœ‹æœ€è¿‘çš„æ—¥å¿—:"
        kubectl logs -n $NAMESPACE -l app=open-deep-research --tail=50
        exit 1
    }

echo -e "${GREEN}âœ… Pod å·²å°±ç»ª${NC}"
echo ""

# æ˜¾ç¤ºéƒ¨ç½²çŠ¶æ€
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                                                                           â•‘"
echo "â•‘                        ğŸ‰ éƒ¨ç½²æˆåŠŸï¼                                      â•‘"
echo "â•‘                                                                           â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“Š éƒ¨ç½²çŠ¶æ€"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Pods:"
kubectl get pods -n $NAMESPACE -l app=open-deep-research
echo ""
echo "Services:"
kubectl get svc -n $NAMESPACE -l app=open-deep-research
echo ""

# è·å–å†…éƒ¨è®¿é—®åœ°å€
INTERNAL_URL="http://open-deep-research-service.deep-research.svc.cluster.local"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ”— è®¿é—®ä¿¡æ¯"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "âœ… AKS å†…éƒ¨è®¿é—®åœ°å€:"
echo "   $INTERNAL_URL"
echo ""
echo "ğŸ“ å…¶ä»– Pod å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è°ƒç”¨:"
echo "   curl http://open-deep-research-service.deep-research.svc.cluster.local/health"
echo ""
echo "ğŸ§ª æœ¬åœ°æµ‹è¯•ï¼ˆPort-Forwardï¼‰:"
echo "   kubectl port-forward -n $NAMESPACE svc/open-deep-research-service 8123:80"
echo "   curl http://localhost:8123/health"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“š å¸¸ç”¨å‘½ä»¤"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "æŸ¥çœ‹æ—¥å¿—:"
echo "  kubectl logs -n $NAMESPACE -l app=open-deep-research -f"
echo ""
echo "æŸ¥çœ‹è¯¦ç»†çŠ¶æ€:"
echo "  kubectl describe pod -n $NAMESPACE -l app=open-deep-research"
echo ""
echo "é‡å¯æœåŠ¡:"
echo "  kubectl rollout restart deployment/open-deep-research -n $NAMESPACE"
echo ""
echo "åˆ é™¤æœåŠ¡:"
echo "  kubectl delete namespace $NAMESPACE"
echo ""

echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"

