# ğŸ—ï¸ Cloudflare Tunnel æ¶æ„è¯´æ˜

## ğŸ“Š æ•´ä½“æ¶æ„å›¾

```
                        äº’è”ç½‘ç”¨æˆ·
                            â”‚
                            â”‚ HTTPS è¯·æ±‚
                            â†“
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚   Cloudflare Edge     â”‚
                â”‚   (å…¨çƒ CDN èŠ‚ç‚¹)      â”‚
                â”‚                       â”‚
                â”‚  âœ“ DDoS é˜²æŠ¤          â”‚
                â”‚  âœ“ WAF é˜²æŠ¤           â”‚
                â”‚  âœ“ è‡ªåŠ¨ HTTPS         â”‚
                â”‚  âœ“ Zero Trust è®¤è¯    â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ åŠ å¯†éš§é“
                            â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   Azure AKS é›†ç¾¤             â”‚
            â”‚                             â”‚
            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
            â”‚  â”‚ cloudflare-tunnel     â”‚  â”‚
            â”‚  â”‚ namespace             â”‚  â”‚
            â”‚  â”‚                       â”‚  â”‚
            â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
            â”‚  â”‚  â”‚ cloudflared     â”‚  â”‚  â”‚
            â”‚  â”‚  â”‚ Pod Ã— 2         â”‚  â”‚  â”‚
            â”‚  â”‚  â”‚ (é«˜å¯ç”¨)         â”‚  â”‚  â”‚
            â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
            â”‚              â”‚ HTTP         â”‚
            â”‚              â†“              â”‚
            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
            â”‚  â”‚ deep-research         â”‚  â”‚
            â”‚  â”‚ namespace             â”‚  â”‚
            â”‚  â”‚                       â”‚  â”‚
            â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
            â”‚  â”‚  â”‚ ODR Service     â”‚  â”‚  â”‚
            â”‚  â”‚  â”‚ Port: 8123      â”‚  â”‚  â”‚
            â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
            â”‚  â”‚           â”‚            â”‚  â”‚
            â”‚  â”‚           â†“            â”‚  â”‚
            â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
            â”‚  â”‚  â”‚ ODR Pod         â”‚  â”‚  â”‚
            â”‚  â”‚  â”‚ (ç ”ç©¶å¼•æ“)       â”‚  â”‚  â”‚
            â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
            â”‚              â”‚ HTTP         â”‚
            â”‚              â†“              â”‚
            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
            â”‚  â”‚ default namespace     â”‚  â”‚
            â”‚  â”‚                       â”‚  â”‚
            â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
            â”‚  â”‚  â”‚ Perplexica Svc  â”‚  â”‚  â”‚
            â”‚  â”‚  â”‚ Port: 80        â”‚  â”‚  â”‚
            â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
            â”‚  â”‚           â”‚            â”‚  â”‚
            â”‚  â”‚           â†“            â”‚  â”‚
            â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
            â”‚  â”‚  â”‚ Perplexica Pod  â”‚  â”‚  â”‚
            â”‚  â”‚  â”‚ (æœç´¢å¼•æ“)       â”‚  â”‚  â”‚
            â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ HTTPS
                            â†“
                    å¤–éƒ¨æœç´¢å¼•æ“
                (Google, Bing, etc.)
```

---

## ğŸ”„ è¯·æ±‚æµç¨‹è¯¦è§£

### å…¸å‹ç ”ç©¶è¯·æ±‚çš„å®Œæ•´æµç¨‹

```
1ï¸âƒ£ ç”¨æˆ·å‘èµ·è¯·æ±‚
   â””â”€ POST https://odr-api.yourdomain.com/threads
      â””â”€ Headers: CF-Access-Client-Id, CF-Access-Client-Secret

2ï¸âƒ£ Cloudflare Edge å¤„ç†
   â”œâ”€ DDoS æ£€æµ‹å’Œé˜²æŠ¤
   â”œâ”€ WAF è§„åˆ™æ£€æŸ¥
   â”œâ”€ Zero Trust è®¤è¯éªŒè¯
   â”‚  â””â”€ éªŒè¯ Service Token æˆ– Email è®¤è¯
   â””â”€ å¦‚æœé€šè¿‡ â†’ è½¬å‘åˆ° Tunnel

3ï¸âƒ£ cloudflared Pod æ¥æ”¶
   â”œâ”€ é€šè¿‡åŠ å¯†éš§é“æ¥æ”¶è¯·æ±‚
   â”œâ”€ è§£å¯†å¹¶è½¬å‘åˆ°å†…éƒ¨æœåŠ¡
   â””â”€ è·¯ç”±åˆ°: open-deep-research-service.deep-research:8123

4ï¸âƒ£ ODR æœåŠ¡å¤„ç†
   â”œâ”€ åˆ›å»ºç ”ç©¶çº¿ç¨‹
   â”œâ”€ åˆ†æç ”ç©¶é—®é¢˜
   â”œâ”€ ç”Ÿæˆæœç´¢ç­–ç•¥
   â””â”€ å¼€å§‹å¤šè½®ç ”ç©¶å¾ªç¯

5ï¸âƒ£ è°ƒç”¨ Perplexica æœç´¢
   â”œâ”€ HTTP â†’ perplexica-service.default:80
   â”œâ”€ æœç´¢å¤šä¸ªå¼•æ“ï¼ˆGoogle, Bing, DuckDuckGoï¼‰
   â”œâ”€ æå–å®Œæ•´ç½‘é¡µå†…å®¹
   â””â”€ è¿”å›ç»“æ„åŒ–ç»“æœ

6ï¸âƒ£ ODR åˆ†æå’ŒæŠ¥å‘Šç”Ÿæˆ
   â”œâ”€ GPT-4o åˆ†ææœç´¢ç»“æœ
   â”œâ”€ å¤šè½®è¿­ä»£ç ”ç©¶
   â”œâ”€ æ•´åˆå¤šä¸ªæ¥æº
   â””â”€ ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š (10000+ tokens)

7ï¸âƒ£ å“åº”è¿”å›
   â””â”€ ODR â†’ cloudflared â†’ Cloudflare Edge â†’ ç”¨æˆ·
      â””â”€ å…¨ç¨‹ HTTPS åŠ å¯†
```

---

## ğŸ” å®‰å…¨å±‚çº§

### å››å±‚å®‰å…¨é˜²æŠ¤

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 1: Cloudflare Edge Security      â”‚
â”‚  âœ“ DDoS é˜²æŠ¤ (è‡ªåŠ¨)                     â”‚
â”‚  âœ“ WAF é˜²æŠ¤ (å¯é…ç½®)                    â”‚
â”‚  âœ“ Rate Limiting (å¯é…ç½®)               â”‚
â”‚  âœ“ Bot æ£€æµ‹ (è‡ªåŠ¨)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 2: Zero Trust Access Control     â”‚
â”‚  âœ“ Service Token è®¤è¯                   â”‚
â”‚  âœ“ Email è®¤è¯                           â”‚
â”‚  âœ“ IP ç™½åå• (å¯é€‰)                     â”‚
â”‚  âœ“ åœ°ç†ä½ç½®é™åˆ¶ (å¯é€‰)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 3: Encrypted Tunnel              â”‚
â”‚  âœ“ TLS 1.3 åŠ å¯†                         â”‚
â”‚  âœ“ æ— éœ€å…¬ç½‘ IP                          â”‚
â”‚  âœ“ æ— éœ€å¼€æ”¾ç«¯å£                         â”‚
â”‚  âœ“ è‡ªåŠ¨é‡è¿å’Œè´Ÿè½½å‡è¡¡                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 4: Kubernetes Network Policy     â”‚
â”‚  âœ“ Namespace éš”ç¦»                       â”‚
â”‚  âœ“ Service-to-Service è®¤è¯              â”‚
â”‚  âœ“ Pod-to-Pod åŠ å¯† (å¯é€‰)               â”‚
â”‚  âœ“ NetworkPolicy é™åˆ¶ (å¯é€‰)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ ç»„ä»¶è¯¦è§£

### cloudflared Pod

**åŠŸèƒ½**: Cloudflare Tunnel å®¢æˆ·ç«¯

**å…³é”®ç‰¹æ€§**:
- 2 ä¸ªå‰¯æœ¬ï¼ˆé«˜å¯ç”¨ï¼‰
- è‡ªåŠ¨å¥åº·æ£€æŸ¥
- å†…å­˜å ç”¨: ~64Mi
- CPU å ç”¨: ~100m

**é…ç½®**:
```yaml
replicas: 2
resources:
  requests:
    memory: "64Mi"
    cpu: "100m"
  limits:
    memory: "128Mi"
    cpu: "200m"
```

**å¥åº·æ£€æŸ¥**:
- Liveness Probe: HTTP GET /ready (port 2000)
- Readiness Probe: HTTP GET /ready (port 2000)

---

### Open Deep Research Service

**åŠŸèƒ½**: æ·±åº¦ç ”ç©¶æŠ¥å‘Šç”Ÿæˆ

**å†…éƒ¨åœ°å€**:
```
http://open-deep-research-service.deep-research.svc.cluster.local:8123
```

**ä¸»è¦ç«¯ç‚¹**:
- `POST /threads` - åˆ›å»ºç ”ç©¶çº¿ç¨‹
- `POST /threads/{id}/runs/stream` - æ‰§è¡Œç ”ç©¶ï¼ˆæµå¼ï¼‰
- `GET /threads/{id}` - è·å–çº¿ç¨‹çŠ¶æ€

**èµ„æºé…ç½®**:
- Memory: 512Mi-1Gi
- CPU: 500m-1000m
- ä½¿ç”¨ GPT-4o (16K tokens è¾“å‡º)

---

### Perplexica Service

**åŠŸèƒ½**: AI æœç´¢å¼•æ“

**å†…éƒ¨åœ°å€**:
```
http://perplexica-service.default.svc.cluster.local:80
```

**ä¸»è¦ç«¯ç‚¹**:
- `POST /api/tavily` - Tavily å…¼å®¹æœç´¢ API

**ç‰¹æ€§**:
- 22 ä¸ªå¯æ§å‚æ•°
- å¤šæœç´¢å¼•æ“æ”¯æŒ
- å®Œæ•´å†…å®¹æå–
- æ—¶é—´èŒƒå›´è¿‡æ»¤

---

## ğŸŒ ç½‘ç»œæ‹“æ‰‘

### Kubernetes å†…éƒ¨ç½‘ç»œ

```
cloudflare-tunnel namespace
â”œâ”€ cloudflared Service (ClusterIP)
â”‚  â””â”€ Port: 2000 (metrics)
â””â”€ cloudflared Pods Ã— 2

deep-research namespace
â”œâ”€ open-deep-research-service (ClusterIP)
â”‚  â””â”€ Port: 8123
â””â”€ open-deep-research Pod Ã— 1

default namespace
â”œâ”€ perplexica-service (ClusterIP)
â”‚  â””â”€ Port: 80
â””â”€ perplexica Pod Ã— 1
```

### è·¨ Namespace é€šä¿¡

cloudflared å¯ä»¥è®¿é—®ä»»ä½• namespace çš„æœåŠ¡:
```
æ ¼å¼: <service-name>.<namespace>.svc.cluster.local:<port>

ç¤ºä¾‹:
- open-deep-research-service.deep-research.svc.cluster.local:8123
- perplexica-service.default.svc.cluster.local:80
```

---

## ğŸ’° èµ„æºå’Œæˆæœ¬

### èµ„æºå ç”¨

| ç»„ä»¶ | CPU | Memory | Pods | æ€»æˆæœ¬/æœˆ |
|------|-----|--------|------|-----------|
| cloudflared | 100m Ã— 2 | 64Mi Ã— 2 | 2 | ~$5 |
| ODR | 500m | 512Mi | 1 | ~$50 |
| Perplexica | 250m | 256Mi | 1 | ~$30 |
| **æ€»è®¡** | 1000m | 960Mi | 4 | ~$85 |

### ç½‘ç»œæµé‡æˆæœ¬

- **å…¥ç«™æµé‡**: å…è´¹ï¼ˆCloudflare â†’ AKSï¼‰
- **å‡ºç«™æµé‡**: ~$0.05/GBï¼ˆAKS â†’ Cloudflareï¼‰
- **é¢„è®¡**: $5-20/æœˆï¼ˆå–å†³äºä½¿ç”¨é‡ï¼‰

### å¤–éƒ¨æœåŠ¡æˆæœ¬

- **Cloudflare Tunnel**: å…è´¹ âœ…
- **Cloudflare Zero Trust**: å…è´¹ï¼ˆ50 ç”¨æˆ·ä»¥å†…ï¼‰âœ…
- **OpenAI API**: æŒ‰ä½¿ç”¨è®¡è´¹ï¼ˆ$0.30-0.80/æ¬¡ç ”ç©¶ï¼‰

---

## ğŸ”„ é«˜å¯ç”¨æ€§è®¾è®¡

### cloudflared é«˜å¯ç”¨

```
2 ä¸ª Pod å‰¯æœ¬
â”œâ”€ è‡ªåŠ¨è´Ÿè½½å‡è¡¡
â”œâ”€ æ•…éšœè‡ªåŠ¨åˆ‡æ¢
â”œâ”€ å¥åº·æ£€æŸ¥é©±åŠ¨
â””â”€ æ»šåŠ¨æ›´æ–°ï¼ˆé›¶åœæœºï¼‰
```

### ODR æ‰©å±•æ€§

```
å½“å‰: 1 ä¸ª Pod
å¯æ‰©å±•åˆ°:
â”œâ”€ Horizontal Pod Autoscaling (HPA)
â”œâ”€ åŸºäº CPU/Memory è‡ªåŠ¨æ‰©å±•
â””â”€ æœ€å¤§: 10 ä¸ª Pods
```

### Perplexica æ‰©å±•æ€§

```
å½“å‰: 1 ä¸ª Pod
å¯æ‰©å±•åˆ°:
â”œâ”€ å¤šä¸ª Pods å¹¶è¡Œæœç´¢
â”œâ”€ åŸºäºè¯·æ±‚é‡è‡ªåŠ¨æ‰©å±•
â””â”€ æœ€å¤§: 20 ä¸ª Pods
```

---

## ğŸ¯ æœªæ¥æ‰©å±•æ–¹å‘

### 1. æ€§èƒ½ä¼˜åŒ–
- [ ] æ·»åŠ  Redis ç¼“å­˜å±‚
- [ ] å®ç°æœç´¢ç»“æœç¼“å­˜
- [ ] å¢åŠ  CDN ç¼“å­˜ç­–ç•¥

### 2. ç›‘æ§å’Œæ—¥å¿—
- [ ] é›†æˆ Prometheus + Grafana
- [ ] æ·»åŠ åˆ†å¸ƒå¼è¿½è¸ª (Jaeger)
- [ ] å®æ—¶å‘Šè­¦é…ç½®

### 3. å®‰å…¨å¢å¼º
- [ ] å®ç° mTLSï¼ˆPod é—´åŠ å¯†ï¼‰
- [ ] æ·»åŠ  Network Policy
- [ ] é›†æˆ Secrets ç®¡ç†ï¼ˆVaultï¼‰

### 4. åŠŸèƒ½æ‰©å±•
- [ ] æ”¯æŒå¤šæ¨¡å‹åˆ‡æ¢
- [ ] æ·»åŠ ç ”ç©¶å†å²å­˜å‚¨
- [ ] å®ç°åä½œç ”ç©¶åŠŸèƒ½

---

## ğŸ“š å‚è€ƒèµ„æ–™

- **Cloudflare Tunnel æ–‡æ¡£**: https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/
- **Zero Trust æ–‡æ¡£**: https://developers.cloudflare.com/cloudflare-one/
- **Kubernetes ç½‘ç»œ**: https://kubernetes.io/docs/concepts/services-networking/
- **AKS æ–‡æ¡£**: https://docs.microsoft.com/azure/aks/

---

## ğŸ¤ æ”¯æŒå’Œåé¦ˆ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æŸ¥çœ‹:
- `README.md` - è¯¦ç»†éƒ¨ç½²æŒ‡å—
- `QUICK_START.md` - å¿«é€Ÿå¼€å§‹
- æ—¥å¿—: `kubectl logs -n cloudflare-tunnel -l app=cloudflared -f`


