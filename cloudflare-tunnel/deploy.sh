#!/bin/bash

set -e

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                                                                           â•‘"
echo "â•‘           ğŸŒ Cloudflare Tunnel éƒ¨ç½²è„šæœ¬ for Open Deep Research           â•‘"
echo "â•‘                                                                           â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# æ£€æŸ¥æ˜¯å¦æä¾›äº† Token
if [ -z "$1" ]; then
    echo "âŒ é”™è¯¯: è¯·æä¾› Cloudflare Tunnel Token"
    echo ""
    echo "ç”¨æ³•: ./deploy.sh YOUR_TUNNEL_TOKEN"
    echo ""
    echo "è·å– Token çš„æ­¥éª¤:"
    echo "  1. è®¿é—® https://one.dash.cloudflare.com/"
    echo "  2. å¯¼èˆªåˆ° Access â†’ Tunnels"
    echo "  3. åˆ›å»ºæ–° Tunnel æˆ–æŸ¥çœ‹ç°æœ‰ Tunnel"
    echo "  4. å¤åˆ¶ Token"
    exit 1
fi

TUNNEL_TOKEN="$1"

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“‹ éƒ¨ç½²æ­¥éª¤"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# 1. åˆ›å»º namespace
echo "1ï¸âƒ£ åˆ›å»º cloudflare-tunnel namespace..."
kubectl apply -f namespace.yaml
echo "   âœ… Namespace åˆ›å»ºå®Œæˆ"
echo ""

# 2. åˆ›å»º Secret
echo "2ï¸âƒ£ åˆ›å»º Cloudflare Tunnel Secret..."
kubectl create secret generic cloudflared-token \
  --from-literal=token="$TUNNEL_TOKEN" \
  --namespace=cloudflare-tunnel \
  --dry-run=client -o yaml | kubectl apply -f -
echo "   âœ… Secret åˆ›å»ºå®Œæˆ"
echo ""

# 3. éƒ¨ç½² cloudflared
echo "3ï¸âƒ£ éƒ¨ç½² cloudflared..."
kubectl apply -f deployment.yaml
echo "   âœ… Deployment åˆ›å»ºå®Œæˆ"
echo ""

# 4. ç­‰å¾… Pod å°±ç»ª
echo "4ï¸âƒ£ ç­‰å¾… cloudflared Pods å¯åŠ¨..."
kubectl wait --for=condition=ready pod \
  -n cloudflare-tunnel \
  -l app=cloudflared \
  --timeout=120s
echo "   âœ… Pods å·²å°±ç»ª"
echo ""

# 5. æ˜¾ç¤ºçŠ¶æ€
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“Š éƒ¨ç½²çŠ¶æ€"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
kubectl get pods -n cloudflare-tunnel
echo ""

# 6. æ˜¾ç¤ºæ—¥å¿—
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“ æœ€è¿‘çš„æ—¥å¿— (æ£€æŸ¥è¿æ¥çŠ¶æ€):"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
kubectl logs -n cloudflare-tunnel -l app=cloudflared --tail=20 | head -15
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… Cloudflared éƒ¨ç½²å®Œæˆï¼"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ“ ä¸‹ä¸€æ­¥:"
echo "   1. è¿”å› Cloudflare æ§åˆ¶å°"
echo "   2. é…ç½® Public Hostnameï¼ˆå°†åŸŸåæŒ‡å‘ ODR æœåŠ¡ï¼‰"
echo "   3. é…ç½®è®¿é—®ç­–ç•¥ï¼ˆå¯é€‰ï¼Œå¢å¼ºå®‰å…¨æ€§ï¼‰"
echo ""
echo "ğŸ” æŸ¥çœ‹å®æ—¶æ—¥å¿—:"
echo "   kubectl logs -n cloudflare-tunnel -l app=cloudflared -f"
echo ""


